<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Akreditif Sistemi</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .admin-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
    }
    .admin-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .admin-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .admin-section h3 {
      margin: 0 0 15px;
      color: var(--accent);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      background: #0e1727;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
    }
    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }
    .status-success {
      background: #065f46;
      color: #d1fae5;
      border: 1px solid #10b981;
    }
    .status-error {
      background: #991b1b;
      color: #fecaca;
      border: 1px solid #ef4444;
    }
    .nav-links {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .nav-links a {
      background: var(--accent);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
    }
    .nav-links a:hover {
      background: #2563eb;
    }
    .api-key-display {
      background: #1e293b;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
      word-break: break-all;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Login Form -->
    <div id="loginForm" class="admin-section">
      <div class="admin-header">
        <h1>🔐 Admin Girişi</h1>
        <p>Yönetim paneline erişim için giriş yapın</p>
      </div>
      
      <div class="form-group">
        <label for="adminUsername">Kullanıcı Adı:</label>
        <input type="text" id="adminUsername" placeholder="admin" />
      </div>
      <div class="form-group">
        <label for="adminPassword">Şifre:</label>
        <input type="password" id="adminPassword" placeholder="••••••••" />
      </div>
      <button id="loginBtn" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%;">Giriş Yap</button>
      <div id="loginStatus" class="status-message" style="display: none;"></div>
    </div>

    <!-- Admin Panel Content (Hidden by default) -->
    <div id="adminContent" style="display: none;">
      <div class="admin-header">
        <h1>🔧 Admin Panel</h1>
        <p>Akreditif Sistemi Yönetim Paneli</p>
        <button id="logoutBtn" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">Çıkış Yap</button>
      </div>

      <div class="nav-links">
        <a href="index.html">Başvuru Formu</a>
        <a href="mt700.html">MT700 Formu</a>
        <a href="admin.html" class="active">Admin Panel</a>
      </div>

    <div class="admin-section">
      <h3>🔑 OpenAI API Key Yönetimi</h3>
      <div class="form-group">
        <label for="adminApiKey">OpenAI API Key:</label>
        <input type="password" id="adminApiKey" placeholder="sk-..." />
      </div>
      <button id="saveAdminApiKey" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">API Key Kaydet</button>
      <button id="testApiKey" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">API Key Test Et</button>
      <div id="apiKeyStatus" class="status-message" style="display: none;"></div>
      
      <div id="currentApiKey" style="margin-top: 15px;">
        <strong>Mevcut API Key:</strong>
        <div class="api-key-display" id="apiKeyDisplay">Yükleniyor...</div>
      </div>
    </div>

    <div class="admin-section">
      <h3>📊 Sistem Durumu</h3>
      <div class="form-group">
        <label>Sistem Bilgileri:</label>
        <div style="background: #1e293b; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px;">
          <div>✅ Başvuru Formu: Aktif</div>
          <div>✅ MT700 Formu: Aktif</div>
          <div>✅ AI Kontrol Sistemi: <span id="aiStatus">Kontrol Ediliyor...</span></div>
          <div>✅ PDF Export: Aktif</div>
          <div>✅ Senkronizasyon: Aktif</div>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <h3>📋 Kullanım İstatistikleri</h3>
      <div class="form-group">
        <label>Son Kullanım:</label>
        <div style="background: #1e293b; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px;">
          <div>Son AI Kontrol: <span id="lastAiCheck">-</span></div>
          <div>Toplam Form Doldurma: <span id="totalForms">-</span></div>
          <div>Son PDF Export: <span id="lastPdfExport">-</span></div>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <h3>📋 AI Alan Kuralları Yönetimi</h3>
      <div class="form-group">
        <label>Form Alanı Seçin:</label>
        <select id="fieldSelector" style="width: 100%; padding: 10px; background: #0e1727; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0;">
          <option value="">Alan seçin...</option>
          <optgroup label="Başvuru Formu Alanları">
            <option value="f27">27 - Teklif ve ekleri</option>
            <option value="f40A">40A - Akreditifin Formu</option>
            <option value="f20">20 - Akreditif numarası</option>
            <option value="f31C">31C - Düzenlenme tarihi</option>
            <option value="f40E">40E - Uygulanacak kurallar</option>
            <option value="f31D">31D - Akreditifin vadesi</option>
            <option value="f51a">51a - Amir/Alıcının bankası</option>
            <option value="f50">50 - Amir/Alıcı</option>
            <option value="f59">59 - Lehtar/Satıcı</option>
            <option value="f32B_ccy">32B - Para Cinsi</option>
            <option value="f32B_amt">32B - Tutar</option>
            <option value="f39A">39A - Tolerans</option>
            <option value="f39B">39B - Maksimum Tutar</option>
            <option value="f39C">39C - İlave Dahili Tutarlar</option>
            <option value="f41a_bank">41a - Banka</option>
            <option value="f41a_role">41a - Görev</option>
            <option value="f42C">42C - Poliçe vadesi</option>
            <option value="f42a_drawee">42a - Drawee</option>
            <option value="f42M">42M - Karışık Ödeme Detayları</option>
            <option value="f42P">42P - İştira/Vadeli Akreditif Detayları</option>
            <option value="f43P">43P - Kısmi Yüklemeler</option>
            <option value="f43T">43T - Aktarma</option>
            <option value="f44A">44A - Malı Teslim Alma Yeri</option>
            <option value="f44E">44E - Yükleme Limanı</option>
            <option value="f44F">44F - Boşaltma Limanı</option>
            <option value="f44B">44B - Teslim Etme Yeri</option>
            <option value="f44C">44C - Son Yükleme Tarihi</option>
            <option value="f44D">44D - Yükleme Süresi</option>
            <option value="f45A">45A - Mal ve Hizmetlerin Tanımı</option>
            <option value="f46A">46A - Gerekli Belgeler</option>
            <option value="f47A">47A - İlave Şartlar</option>
            <option value="f49G">49G - Lehtar için Özel Ödeme</option>
            <option value="f49H">49H - Alan Banka için Özel Ödeme</option>
            <option value="f71D">71D - Masraflar</option>
            <option value="f48">48 - İbraz süresi</option>
            <option value="f49">49 - Teyit Talimatı</option>
            <option value="f58a">58a - Teyit Talep Edilen Taraf</option>
            <option value="f57a">57a - İkinci İhbar Bankası</option>
          </optgroup>
          <optgroup label="MT700 Formu Alanları">
            <option value="mt27">mt27 - Toplam Dizisi</option>
            <option value="mt40A">mt40A - Akreditifin Formu</option>
            <option value="mt20">mt20 - Akreditif Numarası</option>
            <option value="mt23">mt23 - Ön İhbar Referansı</option>
            <option value="mt31C">mt31C - Düzenlenme Tarihi</option>
            <option value="mt40E">mt40E - Uygulanacak Kurallar</option>
            <option value="mt31D">mt31D - Vade ve Yer</option>
            <option value="mt51a">mt51a - Amir Banka</option>
            <option value="mt50">mt50 - Amir</option>
            <option value="mt59">mt59 - Lehtar</option>
            <option value="mt32B_ccy">mt32B - Para Cinsi</option>
            <option value="mt32B_amt">mt32B - Tutar</option>
            <option value="mt39A">mt39A - Tolerans</option>
            <option value="mt39B">mt39B - Maksimum Tutar</option>
            <option value="mt39C">mt39C - İlave Tutarlar</option>
            <option value="mt41a_bank">mt41a - Banka</option>
            <option value="mt41a_role">mt41a - Görev</option>
            <option value="mt42C">mt42C - Poliçe Vadesi</option>
            <option value="mt42a">mt42a - Drawee</option>
            <option value="mt42M">mt42M - Karışık Ödeme</option>
            <option value="mt42P">mt42P - Vadeli Detay</option>
            <option value="mt43P">mt43P - Kısmi Yükleme</option>
            <option value="mt43T">mt43T - Aktarma</option>
            <option value="mt44A">mt44A - Teslim Alma Yeri</option>
            <option value="mt44E">mt44E - Yükleme Limanı</option>
            <option value="mt44F">mt44F - Boşaltma Limanı</option>
            <option value="mt44B">mt44B - Teslim Yeri</option>
            <option value="mt44C">mt44C - Son Yükleme Tarihi</option>
            <option value="mt44D">mt44D - Yükleme Periyodu</option>
            <option value="mt45A">mt45A - Mal Tanımı</option>
            <option value="mt46A">mt46A - Belgeler</option>
            <option value="mt47A">mt47A - İlave Şartlar</option>
            <option value="mt49G">mt49G - Lehtar Özel Ödeme</option>
            <option value="mt49H">mt49H - Banka Özel Ödeme</option>
            <option value="mt71D">mt71D - Masraflar</option>
            <option value="mt48">mt48 - İbraz Süresi</option>
            <option value="mt49">mt49 - Teyit Talimatı</option>
            <option value="mt58a">mt58a - Teyit Bankası</option>
            <option value="mt53a">mt53a - Ödeme Bankası</option>
            <option value="mt78">mt78 - Ödeme Talimatları</option>
            <option value="mt57a">mt57a - İkinci İhbar Bankası</option>
            <option value="mt72Z">mt72Z - Serbest Mesaj</option>
          </optgroup>
        </select>
      </div>
      
      <div class="form-group">
        <label for="fieldRule">Alan Kuralı:</label>
        <textarea id="fieldRule" rows="4" placeholder="Bu alan için AI direktifini yazın..." style="width: 100%; padding: 10px; background: #0e1727; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0;"></textarea>
      </div>
      
      <div class="form-group">
        <label for="fieldExamples">Örnek Değerler (virgülle ayırın):</label>
        <input type="text" id="fieldExamples" placeholder="Örnek1, Örnek2, Örnek3" style="width: 100%; padding: 10px; background: #0e1727; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0;">
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
        <button id="saveFieldRule" style="background: #059669; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Kural Kaydet</button>
        <button id="loadFieldRule" style="background: #0ea5e9; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Kural Yükle</button>
        <button id="deleteFieldRule" style="background: #dc2626; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Kural Sil</button>
        <button id="testFieldRule" style="background: #7c3aed; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Kural Test Et</button>
        <button id="resetToDefaults" style="background: #f59e0b; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Varsayılanlara Sıfırla</button>
      </div>
      
      <div id="fieldRuleStatus" class="status-message" style="display: none; margin-top: 10px;"></div>
      
      <div id="fieldRulesList" style="margin-top: 20px;">
        <h4>Kayıtlı Alan Kuralları:</h4>
        <div id="rulesList" style="background: #1e293b; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto;">
          <div style="color: #94a3b8; font-style: italic;">Henüz kural eklenmemiş</div>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <h3>🛠️ Sistem Araçları</h3>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="clearAllData" style="background: #dc2626; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Tüm Verileri Temizle</button>
        <button id="exportSettings" style="background: #7c3aed; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Ayarları Dışa Aktar</button>
        <button id="importSettings" style="background: #059669; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Ayarları İçe Aktar</button>
      </div>
    </div>
    </div>
  </div>

    <script src="config.sample.js"></script>
    <script src="config.js"></script>
  <script>
    // Admin Panel JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      // CONFIG fallback already loaded from config.sample.js if config.js is absent

      // Login elements
      const loginForm = document.getElementById('loginForm');
      const adminContent = document.getElementById('adminContent');
      const adminUsername = document.getElementById('adminUsername');
      const adminPassword = document.getElementById('adminPassword');
      const loginBtn = document.getElementById('loginBtn');
      const loginStatus = document.getElementById('loginStatus');
      const logoutBtn = document.getElementById('logoutBtn');

      // Admin credentials from config
      const ADMIN_CREDENTIALS = {
        username: CONFIG.ADMIN_USERNAME,
        password: CONFIG.ADMIN_PASSWORD
      };

      // Check if user is already logged in
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('admin_logged_in') === 'true';
        if (isLoggedIn) {
          showAdminPanel();
        } else {
          showLoginForm();
        }
      }

      // Show login form
      function showLoginForm() {
        loginForm.style.display = 'block';
        adminContent.style.display = 'none';
        adminUsername.value = '';
        adminPassword.value = '';
      }

      // Show admin panel
      function showAdminPanel() {
        loginForm.style.display = 'none';
        adminContent.style.display = 'block';
        loadCurrentApiKey();
        updateStats();
      }

      // Login function
      function login() {
        const username = adminUsername.value.trim();
        const password = adminPassword.value.trim();

        if (!username || !password) {
          showLoginStatus('Kullanıcı adı ve şifre gerekli!', 'error');
          return;
        }

        if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
          localStorage.setItem('admin_logged_in', 'true');
          showLoginStatus('✅ Giriş başarılı!', 'success');
          setTimeout(() => {
            showAdminPanel();
          }, 1000);
        } else {
          showLoginStatus('❌ Kullanıcı adı veya şifre hatalı!', 'error');
        }
      }

      // Logout function
      function logout() {
        localStorage.removeItem('admin_logged_in');
        showLoginForm();
      }

      // Show login status
      function showLoginStatus(message, type) {
        loginStatus.textContent = message;
        loginStatus.className = `status-message status-${type}`;
        loginStatus.style.display = 'block';
        
        setTimeout(() => {
          loginStatus.style.display = 'none';
        }, 3000);
      }

      // Event listeners
      loginBtn.addEventListener('click', login);
      logoutBtn.addEventListener('click', logout);
      
      // Enter key support for login
      adminPassword.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          login();
        }
      });

      // Admin Panel elements (only accessible after login)
      const adminApiKeyInput = document.getElementById('adminApiKey');
      const saveAdminApiKeyBtn = document.getElementById('saveAdminApiKey');
      const testApiKeyBtn = document.getElementById('testApiKey');
      const apiKeyStatus = document.getElementById('apiKeyStatus');
      const apiKeyDisplay = document.getElementById('apiKeyDisplay');
      const aiStatus = document.getElementById('aiStatus');
      const lastAiCheck = document.getElementById('lastAiCheck');
      const totalForms = document.getElementById('totalForms');
      const lastPdfExport = document.getElementById('lastPdfExport');
      const clearAllDataBtn = document.getElementById('clearAllData');
      const exportSettingsBtn = document.getElementById('exportSettings');
      const importSettingsBtn = document.getElementById('importSettings');

      // Load current API key
      function loadCurrentApiKey() {
        const savedApiKey = localStorage.getItem('openai_api_key');
        if (savedApiKey) {
          adminApiKeyInput.value = savedApiKey;
          apiKeyDisplay.textContent = savedApiKey.substring(0, 20) + '...';
        } else {
          // Use default API key from config
          if (CONFIG && CONFIG.DEFAULT_OPENAI_API_KEY) {
            adminApiKeyInput.value = CONFIG.DEFAULT_OPENAI_API_KEY;
            apiKeyDisplay.textContent = CONFIG.DEFAULT_OPENAI_API_KEY.substring(0, 20) + '... (Varsayılan)';
          } else {
            adminApiKeyInput.value = '';
            apiKeyDisplay.textContent = 'API Key yüklenemedi';
          }
        }
      }

      // Save API key
      saveAdminApiKeyBtn.addEventListener('click', function() {
        const apiKey = adminApiKeyInput.value.trim();
        if (!apiKey) {
          showStatus('API Key boş olamaz!', 'error');
          return;
        }
        
        if (!apiKey.startsWith('sk-')) {
          showStatus('Geçersiz API Key formatı!', 'error');
          return;
        }

        localStorage.setItem('openai_api_key', apiKey);
        showStatus('✅ API Key başarıyla kaydedildi!', 'success');
        loadCurrentApiKey();
      });

      // Test API key
      testApiKeyBtn.addEventListener('click', async function() {
        const apiKey = adminApiKeyInput.value.trim();
        if (!apiKey) {
          showStatus('Önce API Key girin!', 'error');
          return;
        }

        showStatus('API Key test ediliyor...', 'success');
        
        try {
          const response = await fetch('https://api.openai.com/v1/models', {
            headers: {
              'Authorization': `Bearer ${apiKey}`
            }
          });

          if (response.ok) {
            showStatus('✅ API Key geçerli ve çalışıyor!', 'success');
            aiStatus.textContent = 'Aktif';
            
            // Save the working API key
            localStorage.setItem('openai_api_key', apiKey);
            loadCurrentApiKey();
          } else {
            const errorData = await response.json().catch(() => ({}));
            showStatus(`❌ API Key geçersiz! Hata: ${response.status} ${response.statusText}${errorData.error ? ' - ' + errorData.error.message : ''}`, 'error');
            aiStatus.textContent = 'Hatalı';
          }
        } catch (error) {
          showStatus('❌ API Key test edilemedi: ' + error.message, 'error');
          aiStatus.textContent = 'Hatalı';
        }
      });

      // Clear all data
      clearAllDataBtn.addEventListener('click', function() {
        if (confirm('Tüm verileri temizlemek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
          localStorage.clear();
          showStatus('✅ Tüm veriler temizlendi!', 'success');
          loadCurrentApiKey();
          updateStats();
        }
      });

      // Export settings
      exportSettingsBtn.addEventListener('click', function() {
        const settings = {
          apiKey: localStorage.getItem('openai_api_key'),
          timestamp: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'akreditif-settings.json';
        a.click();
        URL.revokeObjectURL(url);
        
        showStatus('✅ Ayarlar dışa aktarıldı!', 'success');
      });

      // Import settings
      importSettingsBtn.addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                const settings = JSON.parse(e.target.result);
                if (settings.apiKey) {
                  localStorage.setItem('openai_api_key', settings.apiKey);
                  showStatus('✅ Ayarlar başarıyla içe aktarıldı!', 'success');
                  loadCurrentApiKey();
                } else {
                  showStatus('❌ Geçersiz ayar dosyası!', 'error');
                }
              } catch (error) {
                showStatus('❌ Dosya okunamadı: ' + error.message, 'error');
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      });

      // Show status message
      function showStatus(message, type) {
        apiKeyStatus.textContent = message;
        apiKeyStatus.className = `status-message status-${type}`;
        apiKeyStatus.style.display = 'block';
        
        setTimeout(() => {
          apiKeyStatus.style.display = 'none';
        }, 5000);
      }

      // Update statistics
      function updateStats() {
        const lastAiCheckTime = localStorage.getItem('last_ai_check');
        const totalFormsCount = localStorage.getItem('total_forms') || '0';
        const lastPdfExportTime = localStorage.getItem('last_pdf_export');

        lastAiCheck.textContent = lastAiCheckTime ? new Date(lastAiCheckTime).toLocaleString('tr-TR') : '-';
        totalForms.textContent = totalFormsCount;
        lastPdfExport.textContent = lastPdfExportTime ? new Date(lastPdfExportTime).toLocaleString('tr-TR') : '-';
      }

      // Field Rules Management
      const fieldSelector = document.getElementById('fieldSelector');
      const fieldRule = document.getElementById('fieldRule');
      const fieldExamples = document.getElementById('fieldExamples');
      const saveFieldRuleBtn = document.getElementById('saveFieldRule');
      const loadFieldRuleBtn = document.getElementById('loadFieldRule');
      const deleteFieldRuleBtn = document.getElementById('deleteFieldRule');
      const testFieldRuleBtn = document.getElementById('testFieldRule');
      const resetToDefaultsBtn = document.getElementById('resetToDefaults');
      const fieldRuleStatus = document.getElementById('fieldRuleStatus');
      const rulesList = document.getElementById('rulesList');

      // Load default field rules from GitHub repo (shared across all users)
      async function loadDefaultFieldRules() {
        try {
          // First try to load from GitHub repo
          const response = await fetch('default-rules.json');
          if (response.ok) {
            const repoRules = await response.json();
            const existingRules = JSON.parse(localStorage.getItem('field_rules') || '{}');
            
            // Merge repo rules with local rules (local rules take priority)
            const mergedRules = { ...repoRules, ...existingRules };
            
            // Save merged rules back to localStorage
            localStorage.setItem('field_rules', JSON.stringify(mergedRules));
            
            console.log('Default field rules loaded from repo:', Object.keys(repoRules).length, 'rules');
            loadFieldRules(); // Refresh the display
            return;
          }
        } catch (error) {
          console.warn('Could not load rules from repo:', error.message);
        }

        // Fallback to CONFIG if repo loading fails
        if (typeof CONFIG !== 'undefined' && CONFIG.DEFAULT_FIELD_RULES) {
          const existingRules = JSON.parse(localStorage.getItem('field_rules') || '{}');
          const defaultRules = CONFIG.DEFAULT_FIELD_RULES;
          
          // Merge default rules with existing rules (existing rules take priority)
          const mergedRules = { ...defaultRules, ...existingRules };
          
          // Save merged rules back to localStorage
          localStorage.setItem('field_rules', JSON.stringify(mergedRules));
          
          console.log('Default field rules loaded from config:', Object.keys(defaultRules).length, 'rules');
          loadFieldRules(); // Refresh the display
        }
      }

      // Load field rules from localStorage
      function loadFieldRules() {
        const rules = JSON.parse(localStorage.getItem('field_rules') || '{}');
        displayFieldRules(rules);
      }

      // Display field rules
      function displayFieldRules(rules) {
        const rulesArray = Object.entries(rules);
        if (rulesArray.length === 0) {
          rulesList.innerHTML = '<div style="color: #94a3b8; font-style: italic;">Henüz kural eklenmemiş</div>';
          return;
        }

        rulesList.innerHTML = rulesArray.map(([fieldId, rule]) => `
          <div style="background: #0e1727; padding: 10px; margin: 5px 0; border-radius: 6px; border-left: 4px solid #059669;">
            <div style="font-weight: bold; color: #e2e8f0;">${fieldId}</div>
            <div style="color: #94a3b8; font-size: 12px; margin: 5px 0;">${rule.rule.substring(0, 100)}${rule.rule.length > 100 ? '...' : ''}</div>
            <div style="color: #64748b; font-size: 11px;">Örnekler: ${rule.examples || 'Yok'}</div>
            <button onclick="editFieldRule('${fieldId}')" style="background: #0ea5e9; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px;">Düzenle</button>
          </div>
        `).join('');
      }

      // Save field rule
      saveFieldRuleBtn.addEventListener('click', function() {
        const fieldId = fieldSelector.value;
        const rule = fieldRule.value.trim();
        const examples = fieldExamples.value.trim();

        if (!fieldId || !rule) {
          showFieldRuleStatus('Alan ve kural seçin!', 'error');
          return;
        }

        const rules = JSON.parse(localStorage.getItem('field_rules') || '{}');
        rules[fieldId] = {
          rule: rule,
          examples: examples,
          createdAt: new Date().toISOString()
        };

        localStorage.setItem('field_rules', JSON.stringify(rules));
        showFieldRuleStatus('✅ Kural kaydedildi!', 'success');
        loadFieldRules();
        clearFieldRuleForm();
      });

      // Load field rule
      loadFieldRuleBtn.addEventListener('click', function() {
        const fieldId = fieldSelector.value;
        if (!fieldId) {
          showFieldRuleStatus('Alan seçin!', 'error');
          return;
        }

        const rules = JSON.parse(localStorage.getItem('field_rules') || '{}');
        const rule = rules[fieldId];
        
        if (rule) {
          fieldRule.value = rule.rule;
          fieldExamples.value = rule.examples || '';
          showFieldRuleStatus('✅ Kural yüklendi!', 'success');
        } else {
          showFieldRuleStatus('Bu alan için kural bulunamadı!', 'error');
        }
      });

      // Delete field rule
      deleteFieldRuleBtn.addEventListener('click', function() {
        const fieldId = fieldSelector.value;
        if (!fieldId) {
          showFieldRuleStatus('Alan seçin!', 'error');
          return;
        }

        if (confirm('Bu kuralı silmek istediğinizden emin misiniz?')) {
          const rules = JSON.parse(localStorage.getItem('field_rules') || '{}');
          delete rules[fieldId];
          localStorage.setItem('field_rules', JSON.stringify(rules));
          showFieldRuleStatus('✅ Kural silindi!', 'success');
          loadFieldRules();
          clearFieldRuleForm();
        }
      });

      // Test field rule
      testFieldRuleBtn.addEventListener('click', function() {
        const fieldId = fieldSelector.value;
        const rule = fieldRule.value.trim();
        const examples = fieldExamples.value.trim();

        if (!fieldId || !rule) {
          showFieldRuleStatus('Alan ve kural seçin!', 'error');
          return;
        }

        // Test the rule with AI
        testFieldRuleWithAI(fieldId, rule, examples);
      });

      // Test field rule with AI
      async function testFieldRuleWithAI(fieldId, rule, examples) {
        const apiKey = localStorage.getItem('openai_api_key') || CONFIG.DEFAULT_OPENAI_API_KEY;
        if (!apiKey) {
          showFieldRuleStatus('API Key bulunamadı!', 'error');
          return;
        }

        showFieldRuleStatus('AI ile test ediliyor...', 'success');
        
        try {
          const testValue = examples ? examples.split(',')[0].trim() : 'test değer';
          const prompt = `Alan: ${fieldId}
Kural: ${rule}
Test Değeri: ${testValue}

Bu kurala göre test değerini analiz et ve sonucu JSON formatında ver:
{
  "status": "success|warning|error",
  "message": "Analiz sonucu",
  "suggestions": ["öneri1", "öneri2"]
}`;

          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: CONFIG.OPENAI_MODEL,
              messages: [
                {
                  role: 'system',
                  content: 'Sen bir akreditif uzmanısın. Verilen kurallara göre alan değerlerini analiz edersin.'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              max_tokens: CONFIG.MAX_TOKENS,
              temperature: CONFIG.TEMPERATURE
            })
          });

          if (response.ok) {
            const data = await response.json();
            const result = JSON.parse(data.choices[0].message.content);
            showFieldRuleStatus(`✅ Test başarılı! Sonuç: ${result.message}`, 'success');
          } else {
            showFieldRuleStatus('❌ Test başarısız!', 'error');
          }
        } catch (error) {
          showFieldRuleStatus('❌ Test hatası: ' + error.message, 'error');
        }
      }

      // Clear field rule form
      function clearFieldRuleForm() {
        fieldRule.value = '';
        fieldExamples.value = '';
      }

      // Show field rule status
      function showFieldRuleStatus(message, type) {
        fieldRuleStatus.textContent = message;
        fieldRuleStatus.className = `status-message status-${type}`;
        fieldRuleStatus.style.display = 'block';
        
        setTimeout(() => {
          fieldRuleStatus.style.display = 'none';
        }, 3000);
      }

      // Reset to default rules
      resetToDefaultsBtn.addEventListener('click', async function() {
        if (confirm('Tüm kuralları varsayılan değerlere sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
          localStorage.removeItem('field_rules');
          await loadDefaultFieldRules();
          showFieldRuleStatus('✅ Kurallar varsayılan değerlere sıfırlandı!', 'success');
          clearFieldRuleForm();
        }
      });

      // Edit field rule (global function)
      window.editFieldRule = function(fieldId) {
        fieldSelector.value = fieldId;
        loadFieldRuleBtn.click();
      };

      // Initialize field rules
      loadDefaultFieldRules();
      loadFieldRules();

      // Initialize
      checkLoginStatus();
    });
  </script>
</body>
</html>
